# Issue を Project に追加し、優先度/規模/Estimate を自動設定する Reusable Workflow
#
# 目的:
#   - Issue 作成時に Project（Projects v2）へ自動追加
#   - Issue フォームの入力内容から Project のフィールドを更新（優先度/規模/Estimate）
#
# 前提:
#   - Projects v2 に以下のフィールドが存在すること
#       - 優先度（Single select）
#       - 規模（Single select）
#       - Estimate（Number）
#   - Project 更新には `project` 権限を持つトークン（PAT など）が必要になる場合があります
#
# 使い方:
#   - workflow-templates/triage-project-fields-issues.yml を各リポジトリへコピーして利用します

name: Issueトリアージ（Projectフィールド自動設定）

on:
  workflow_call:
    inputs:
      project_owner:
        description: Project の owner（ユーザー名/組織名）
        required: false
        type: string
      project_number:
        description: Project の番号
        required: false
        type: number
        default: 12
      priority_field_name:
        description: 優先度フィールド名（Single select）
        required: false
        type: string
        default: 優先度
      size_field_name:
        description: 規模フィールド名（Single select）
        required: false
        type: string
        default: 規模
      estimate_field_name:
        description: Estimate フィールド名（Number）
        required: false
        type: string
        default: Estimate
    secrets:
      project_token:
        description: Projects v2 更新用トークン（PAT など）
        required: false

permissions:
  contents: read
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Project へ追加しフィールドを更新
        env:
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
          PROJECT_OWNER: ${{ inputs.project_owner || github.repository_owner }}
          PROJECT_NUMBER: ${{ inputs.project_number }}
          PRIORITY_FIELD_NAME: ${{ inputs.priority_field_name }}
          SIZE_FIELD_NAME: ${{ inputs.size_field_name }}
          ESTIMATE_FIELD_NAME: ${{ inputs.estimate_field_name }}
          PROJECT_TOKEN: ${{ secrets.project_token }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          comment() {
            local body="$1"
            GH_TOKEN="${GITHUB_TOKEN}" gh api "repos/${REPO}/issues/${ISSUE_NUMBER}/comments" -f body="$body" >/dev/null || true
          }

          issue_json="$(GH_TOKEN="${GITHUB_TOKEN}" gh api "repos/${REPO}/issues/${ISSUE_NUMBER}")"
          issue_title="$(jq -r '.title // ""' <<<"$issue_json")"
          issue_body="$(jq -r '.body // ""' <<<"$issue_json")"
          issue_url="$(jq -r '.html_url // ""' <<<"$issue_json")"

          extract_first_line_under_heading() {
            local heading="$1"
            awk -v h="### ${heading}" '
              $0==h {in=1; next}
              in && /^### / {exit}
              in {
                if ($0 ~ /^[[:space:]]*$/) next
                print $0
                exit
              }
            ' <<<"$issue_body"
          }

          priority_opt="$(extract_first_line_under_heading "優先度")"
          size_opt="$(extract_first_line_under_heading "規模")"
          estimate_raw="$(extract_first_line_under_heading "Estimate")"

          if [[ -z "${priority_opt:-}" || -z "${size_opt:-}" || -z "${estimate_raw:-}" ]]; then
            comment "Issue フォームから「優先度/規模/Estimate」を取得できませんでした。テンプレ（Issue Forms）の項目名が一致しているか確認してください。\n\n- 取得値: 優先度=${priority_opt:-（空）}, 規模=${size_opt:-（空）}, Estimate=${estimate_raw:-（空）}\n\nIssue: ${issue_url}"
            exit 0
          fi

          # 簡易正規化（P0 のような短縮表記を許容）
          case "$priority_opt" in
            P0) priority_opt="P0: 緊急" ;;
            P1) priority_opt="P1: 高" ;;
            P2) priority_opt="P2: 中" ;;
            P3) priority_opt="P3: 低" ;;
          esac

          estimate_num=0
          if [[ "${estimate_raw}" == "未定" ]]; then
            estimate_num=0
          elif [[ "${estimate_raw}" =~ ^-?[0-9]+$ ]]; then
            estimate_num="${estimate_raw}"
          else
            # 数値以外は 0 扱い
            estimate_num=0
          fi
          if (( estimate_num < 0 )); then estimate_num=0; fi

          if [[ -z "${PROJECT_TOKEN:-}" ]]; then
            comment "Projects v2 を更新するためのトークンが未設定です。`PROJECT_TOKEN`（Project への書き込み権限）を設定してください。\n\n- 取得値: 優先度=${priority_opt}, 規模=${size_opt}, Estimate=${estimate_num}\n\nIssue: ${issue_url}"
            exit 0
          fi

          project_query='
            query($owner:String!, $number:Int!){
              user(login:$owner){
                projectV2(number:$number){
                  id
                  title
                  fields(first:100){
                    nodes{
                      ... on ProjectV2FieldCommon { id name dataType }
                      ... on ProjectV2SingleSelectField { id name dataType options { id name } }
                    }
                  }
                }
              }
              organization(login:$owner){
                projectV2(number:$number){
                  id
                  title
                  fields(first:100){
                    nodes{
                      ... on ProjectV2FieldCommon { id name dataType }
                      ... on ProjectV2SingleSelectField { id name dataType options { id name } }
                    }
                  }
                }
              }
            }'

          project_json="$(GH_TOKEN="${PROJECT_TOKEN}" gh api graphql -f query="$project_query" -F owner="${PROJECT_OWNER}" -F number="${PROJECT_NUMBER}")"
          project_obj="$(jq -c '.data.organization.projectV2 // .data.user.projectV2 // empty' <<<"$project_json")"
          if [[ -z "$project_obj" ]]; then
            comment "Project（${PROJECT_OWNER}/${PROJECT_NUMBER}）の取得に失敗しました。owner/番号が正しいか確認してください。"
            exit 0
          fi

          project_id="$(jq -r '.id' <<<"$project_obj")"
          project_title="$(jq -r '.title' <<<"$project_obj")"

          field_id_by_name() {
            local name="$1"
            jq -r --arg name "$name" '.fields.nodes[] | select(.name==$name) | .id' <<<"$project_obj" | head -n1
          }

          priority_field_id="$(field_id_by_name "${PRIORITY_FIELD_NAME}")"
          size_field_id="$(field_id_by_name "${SIZE_FIELD_NAME}")"
          estimate_field_id="$(field_id_by_name "${ESTIMATE_FIELD_NAME}")"

          missing=()
          [[ -z "${priority_field_id:-}" ]] && missing+=("${PRIORITY_FIELD_NAME}")
          [[ -z "${size_field_id:-}" ]] && missing+=("${SIZE_FIELD_NAME}")
          [[ -z "${estimate_field_id:-}" ]] && missing+=("${ESTIMATE_FIELD_NAME}")
          if (( ${#missing[@]} > 0 )); then
            comment "Project「${project_title}」に必要なフィールドが見つかりません: ${missing[*]}。フィールド名を合わせるか、workflow の inputs（*_field_name）を調整してください。"
            exit 0
          fi

          option_id_by_name() {
            local field_name="$1"
            local option_name="$2"
            jq -r --arg field "$field_name" --arg opt "$option_name" '
              .fields.nodes[]
              | select(.name==$field)
              | .options[]?
              | select(.name==$opt)
              | .id
            ' <<<"$project_obj" | head -n1
          }

          existing_item_query='
            query($contentId:ID!){
              node(id:$contentId){
                ... on Issue {
                  projectItems(first:50){
                    nodes { id project { id } }
                  }
                }
              }
            }'
          existing_items_json="$(GH_TOKEN="${PROJECT_TOKEN}" gh api graphql -f query="$existing_item_query" -F contentId="${ISSUE_NODE_ID}")"
          item_id="$(jq -r --arg pid "$project_id" '.data.node.projectItems.nodes[]? | select(.project.id==$pid) | .id' <<<"$existing_items_json" | head -n1)"

          if [[ -z "${item_id:-}" ]]; then
            add_item_mutation='
              mutation($projectId:ID!, $contentId:ID!){
                addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}){
                  item { id }
                }
              }'
            if ! add_json="$(GH_TOKEN="${PROJECT_TOKEN}" gh api graphql -f query="$add_item_mutation" -F projectId="${project_id}" -F contentId="${ISSUE_NODE_ID}" 2>/dev/null)"; then
              comment "Issue を Project に追加できませんでした（権限不足の可能性があります）。Project: ${PROJECT_OWNER}/${PROJECT_NUMBER}\n\nIssue: ${issue_url}"
              exit 0
            fi
            item_id="$(jq -r '.data.addProjectV2ItemById.item.id // empty' <<<"$add_json")"
          fi

          # 選択肢IDを解決（無ければ提案コメント）
          priority_option_id="$(option_id_by_name "${PRIORITY_FIELD_NAME}" "${priority_opt}")"
          size_option_id="$(option_id_by_name "${SIZE_FIELD_NAME}" "${size_opt}")"

          if [[ -z "${priority_option_id:-}" || -z "${size_option_id:-}" ]]; then
            comment "Project の選択肢に一致しないため、自動設定できませんでした。\n\n- 取得値: 優先度=${priority_opt}, 規模=${size_opt}, Estimate=${estimate_num}\n\nProject 側の選択肢名を合わせるか、Issue テンプレの選択肢名を調整してください。\n\nIssue: ${issue_url}"
            exit 0
          fi

          update_mutation='
            mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $value:ProjectV2FieldValue!){
              updateProjectV2ItemFieldValue(input:{
                projectId:$projectId,
                itemId:$itemId,
                fieldId:$fieldId,
                value:$value
              }){
                projectV2Item { id }
              }
            }'

          if ! GH_TOKEN="${PROJECT_TOKEN}" gh api graphql -f query="$update_mutation" \
              -F projectId="${project_id}" \
              -F itemId="${item_id}" \
              -F fieldId="${priority_field_id}" \
              -f value="$(jq -nc --arg id "${priority_option_id}" '{singleSelectOptionId:$id}')" >/dev/null; then
            comment "Project の優先度フィールド更新に失敗しました（権限不足の可能性があります）。\n\n- 推定: 優先度=${priority_opt}\n\nIssue: ${issue_url}"
            exit 0
          fi

          if ! GH_TOKEN="${PROJECT_TOKEN}" gh api graphql -f query="$update_mutation" \
              -F projectId="${project_id}" \
              -F itemId="${item_id}" \
              -F fieldId="${size_field_id}" \
              -f value="$(jq -nc --arg id "${size_option_id}" '{singleSelectOptionId:$id}')" >/dev/null; then
            comment "Project の規模フィールド更新に失敗しました（権限不足の可能性があります）。\n\n- 推定: 規模=${size_opt}\n\nIssue: ${issue_url}"
            exit 0
          fi

          if ! GH_TOKEN="${PROJECT_TOKEN}" gh api graphql -f query="$update_mutation" \
              -F projectId="${project_id}" \
              -F itemId="${item_id}" \
              -F fieldId="${estimate_field_id}" \
              -f value="$(jq -nc --argjson n "${estimate_num}" '{number:$n}')" >/dev/null; then
            comment "Project の Estimate フィールド更新に失敗しました（権限不足の可能性があります）。\n\n- 推定: Estimate=${estimate_num}\n\nIssue: ${issue_url}"
            exit 0
          fi
